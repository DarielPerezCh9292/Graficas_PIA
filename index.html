<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puzzlos</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <audio id="musicaFondo" loop>
        <source src="index.mp3" type="audio/mpeg">
    </audio>

    <i class="Cofre_Clase"></i>
    <div class="Opciones-container">
        <img id="Menu_icono" src="3 rayas.png" alt="Icono de Menú" width="50px" height="50px">
        <div class="opcion-item volume-control hidden">
            <label for="volume-slider">Volumen</label>
            <input type="range" id="volume-slider" min="0" max="100" value="75">
        </div>
        <div class="opcion-item checkbox-control hidden">
            <span>Música</span>
            <label class="switch">
                <input type="checkbox" checked>
                <span class="slider round"></span>
            </label>
        </div>
        <hr class="opcion-item hidden">
        <button class="Opciones-button opcion-item hidden">Puntuaciones</button>
        <hr class="opcion-item hidden">
        <button id="achievementsButton" class="Opciones-button opcion-item hidden">Logros</button>
        <hr class="opcion-item hidden">
        <button class="Opciones-button opcion-item hidden">Guardar Partida</button>
        <hr class="opcion-item hidden">
        <button class="Opciones-button opcion-item hidden" onclick="location.href='index.html';">Salir</button>
        <hr class="opcion-item hidden">
        <button class="Opciones-button opcion-item hidden">Reiniciar</button>
    </div>

    <div class="menu-container">
        <h1>Puzzlos</h1>
        <div id="main-menu-buttons">
            <button class="menu-button" onclick="location.href='niveles.html';">Jugar Individual</button>
            <button class="menu-button" onclick="location.href='niveles_MULTIJUGADOR.html';">Jugar Multijugador</button>
        </div>
        <div id="achievements-screen" class="hidden">
            <div class="achievements-grid">
                <div class="achievement-box"><img class="Logros-img" src="totem.png" alt="Nivel 1"></div>
                <div class="achievement-box"><img class="Logros-img" src="totem.png" alt="Nivel 2"></div>
                <div class="achievement-box"><img class="Logros-img" src="totem.png" alt="Nivel 3"></div>
            </div>
            <button id="back-to-menu-button" class="menu-button">Regresar</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- LÓGICA DE MENÚ EXISTENTE ---
            const toggleButton = document.getElementById('Menu_icono');
            const targetElements = document.querySelectorAll('.opcion-item');

            toggleButton.addEventListener('click', () => {
                targetElements.forEach(element => {
                    element.classList.toggle('hidden');
                });
            });

            const achievementsButton = document.getElementById('achievementsButton');
            const backToMenuButton = document.getElementById('back-to-menu-button');
            const mainMenu = document.getElementById('main-menu-buttons');
            const achievementsScreen = document.getElementById('achievements-screen');

            achievementsButton.addEventListener('click', () => {
                mainMenu.classList.add('hidden');
                achievementsScreen.classList.remove('hidden');
                targetElements.forEach(element => element.classList.add('hidden'));
            });

            backToMenuButton.addEventListener('click', () => {
                achievementsScreen.classList.add('hidden');
                mainMenu.classList.remove('hidden');
                history.pushState("", document.title, window.location.pathname + window.location.search);
            });

            if (window.location.hash === '#achievements') {
                mainMenu.classList.add('hidden');
                achievementsScreen.classList.remove('hidden');
            }

            // =====================================================
            // --- SISTEMA DE AUDIO PERSISTENTE ENTRE PÁGINAS ---
            // =====================================================
            
            const audio = document.getElementById('musicaFondo');
            const sliderVolumen = document.getElementById('volume-slider');
            const checkMusica = document.querySelector('.checkbox-control input');

            // --- PARTE A: RECUPERAR EL ESTADO ANTERIOR ---
            // Leemos la memoria del navegador al cargar la página
            const volumenGuardado = localStorage.getItem('volumenGlobal');
            const tiempoGuardado = localStorage.getItem('musicaTiempo');
            const estabaSonando = localStorage.getItem('musicaSonando');

            // 1. Restaurar Volumen
            if (volumenGuardado !== null) {
                audio.volume = parseFloat(volumenGuardado);
                sliderVolumen.value = audio.volume * 100;
            } else {
                audio.volume = 0.75; // Valor por defecto
            }

            // 2. Restaurar Tiempo (Para que la canción no empiece de 0)
            if (tiempoGuardado !== null) {
                audio.currentTime = parseFloat(tiempoGuardado);
            }

            // 3. Restaurar Reproducción (Play/Pause)
            if (estabaSonando === 'true') {
                checkMusica.checked = true;
                // Intentamos reproducir. Los navegadores modernos a veces bloquean esto
                // hasta que el usuario hace clic, pero como viene de un clic anterior, suele funcionar.
                var playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log("Esperando interacción del usuario para reproducir audio...");
                        // Si falla (bloqueo de navegador), esperamos al primer clic en cualquier lado
                        document.body.addEventListener('click', () => {
                            audio.play();
                        }, { once: true });
                    });
                }
            } else {
                checkMusica.checked = false; 
                // Si el usuario la apagó en la otra página, la dejamos apagada.
            }

            // --- PARTE B: GUARDAR EL ESTADO AL SALIR ---
            // Este evento ocurre justo antes de cambiar de página (ej. al hacer clic en "Jugar")
            window.addEventListener("beforeunload", () => {
                // Si la música está sonando, guardamos el tiempo exacto
                if (!audio.paused) {
                    localStorage.setItem('musicaTiempo', audio.currentTime);
                    localStorage.setItem('musicaSonando', 'true');
                } else {
                    localStorage.setItem('musicaSonando', 'false');
                }
                localStorage.setItem('volumenGlobal', audio.volume);
            });

            // --- PARTE C: CONTROLES NORMALES ---
            sliderVolumen.addEventListener('input', function() {
                audio.volume = this.value / 100;
                // Guardamos el volumen en tiempo real por si recarga la página
                localStorage.setItem('volumenGlobal', audio.volume);
            });

            checkMusica.addEventListener('change', function() {
                if (this.checked) {
                    audio.play();
                    localStorage.setItem('musicaSonando', 'true');
                } else {
                    audio.pause();
                    localStorage.setItem('musicaSonando', 'false');
                }
            });

        });
    </script>
</body>
</html>