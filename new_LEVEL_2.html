<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nivel 2</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="Niveles_style.css">
    <style>
        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <i class="Cofre_Clase"></i>
    <div class="Opciones-container">
        <img id="Menu_icono" src="3 rayas.png" alt="Icono de Menú" width="50px" height="50px">
        <div class="opcion-item volume-control hidden">
            <label for="volume-slider">Volumen</label>
            <input type="range" id="volume-slider" min="0" max="100" value="75">
        </div>
        <div class="opcion-item checkbox-control hidden">
            <span>Música</span>
            <label class="switch">
                <input type="checkbox" checked>
                <span class="slider round"></span>
            </label>
        </div>
        <hr class="opcion-item hidden">
        <button class="Opciones-button opcion-item hidden">Puntuaciones</button>
        <hr class="opcion-item hidden">
        <button id="achievementsButton" class="Opciones-button opcion-item hidden"
            onclick="location.href='index.html#achievements';">Logros</button>
        <hr class="opcion-item hidden">
        <button class="Opciones-button opcion-item hidden">Guardar Partida</button>
        <hr class="opcion-item hidden">
        <button class="Opciones-button opcion-item hidden" onclick="location.href='index.html';">Salir</button>
        <hr class="opcion-item hidden">
        <button class="Opciones-button opcion-item hidden">Reiniciar</button>

        

    </div>

    

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggleButton = document.getElementById('Menu_icono');
            const targetElements = document.querySelectorAll('.opcion-item');

            toggleButton.addEventListener('click', () => {
                targetElements.forEach(element => {
                    element.classList.toggle('hidden');
                });
            });
        });



    </script>

    <script type="module">
        function Set_NivelActual() {
            var VAR_Nivel_Actual = 2;
            localStorage.setItem("Nivel_Actual",VAR_Nivel_Actual);
        }
        
        
        import * as THREE from "./three.module.js";
        import { OrbitControls } from "./OrbitControls.js";
        import { GLTFLoader } from "./GLTFLoader.js";
        
        

        class Cuartos{
            
            
            constructor(positionX, positionY, positionZ, Player_BB, mat_Paredes, mat_Puertas){

                this.positionX = positionX;
                this.positionY = positionY;
                this.positionZ = positionZ;
                this.mat_Paredes = mat_Paredes;
                this.mat_Puertas = mat_Puertas;

                this.Cuarto_Terminado = false;

                this.Colision_Con_Jugador = false;

                this.Player_Temp_BB = Player_BB;

                this.Paredes_Material = new THREE.MeshPhongMaterial();
                //this.Paredes_Textura = new THREE.TextureLoader().load("./uv_texture.jpg");
                this.Paredes_Textura = new THREE.TextureLoader().load(this.mat_Paredes);
                this.Paredes_Material.map = this.Paredes_Textura;

                this.Puertas_Material = new THREE.MeshPhongMaterial();
                //this.Puertas_Textura = new THREE.TextureLoader().load("./temp_puerta.jpg");
                this.Puertas_Textura = new THREE.TextureLoader().load(this.mat_Puertas);
                this.Puertas_Material.map = this.Puertas_Textura;

                this.Wall1_Geometry = new THREE.BoxGeometry(2, 20, 50);
                this.Wall1 = new THREE.Mesh(this.Wall1_Geometry, this.Paredes_Material);
                this.Wall1_BoundBox = new THREE.Box3();
                
                this.Wall5_Geometry = new THREE.BoxGeometry(2, 20, 50);
                this.Wall5 = new THREE.Mesh(this.Wall5_Geometry, this.Paredes_Material);
                this.Wall5_BoundBox = new THREE.Box3();
                

                this.Wall2_Geometry = new THREE.BoxGeometry(18, 20, 2);
                this.Wall2 = new THREE.Mesh(this.Wall2_Geometry, this.Paredes_Material);
                this.Wall2_BoundBox = new THREE.Box3();
                

                this.Wall4_Geometry = new THREE.BoxGeometry(18, 20, 2);
                this.Wall4 = new THREE.Mesh(this.Wall4_Geometry, this.Paredes_Material);
                this.Wall4_BoundBox = new THREE.Box3();
                

                this.Wall8_Geometry = new THREE.BoxGeometry(18, 20, 2);
                this.Wall8 = new THREE.Mesh(this.Wall8_Geometry, this.Paredes_Material);
                this.Wall8_BoundBox = new THREE.Box3();
                

                this.Wall6_Geometry = new THREE.BoxGeometry(18, 20, 2);
                this.Wall6 = new THREE.Mesh(this.Wall6_Geometry, this.Paredes_Material);
                this.Wall6_BoundBox = new THREE.Box3();
                

                this.Wall3_Puerta1_Geometry = new THREE.BoxGeometry(10, 20, 2);
                this.Wall3_Puerta1 = new THREE.Mesh(this.Wall3_Puerta1_Geometry, this.Puertas_Material);
                this.Wall3_Puerta1_BoundBox = new THREE.Box3();
                

                this.Wall7_Puerta2_Geometry = new THREE.BoxGeometry(10, 20, 2);
                this.Wall7_Puerta2 = new THREE.Mesh(this.Wall7_Puerta2_Geometry, this.Puertas_Material);
                this.Wall7_Puerta2_BoundBox = new THREE.Box3();
                

            }

            Construir_Cuarto(){
                
                this.Wall1.position.set(this.positionX + 24, this.positionY + 10, this.positionZ + 0);
                this.Wall1_BoundBox.setFromObject(this.Wall1);
                scene.add(this.Wall1);
                
                this.Wall5.position.set(this.positionX -24, this.positionY +  10, this.positionZ + 0);
                this.Wall5_BoundBox.setFromObject(this.Wall5);
                scene.add(this.Wall5);

                this.Wall2.position.set(this.positionX + 14, this.positionY + 10, this.positionZ - 24);
                this.Wall2_BoundBox.setFromObject(this.Wall2);
                scene.add(this.Wall2);

                this.Wall4.position.set(this.positionX -14, this.positionY + 10, this.positionZ - 24);
                this.Wall4_BoundBox.setFromObject(this.Wall4);
                scene.add(this.Wall4);

                this.Wall8.position.set(this.positionX + 14, this.positionY + 10, this.positionZ + 24);
                this.Wall8_BoundBox.setFromObject(this.Wall8);
                scene.add(this.Wall8);

                this.Wall6.position.set(this.positionX -14, this.positionY + 10, this.positionZ + 24);
                this.Wall6_BoundBox.setFromObject(this.Wall6);
                scene.add(this.Wall6);

                this.Wall3_Puerta1.position.set(this.positionX + 0, this.positionY + 10, this.positionZ - 24);
                this.Wall3_Puerta1_BoundBox.setFromObject(this.Wall3_Puerta1);
                scene.add(this.Wall3_Puerta1);

                this.Wall7_Puerta2.position.set(this.positionX + 0, this.positionY + 10, this.positionZ + 24);
                this.Wall7_Puerta2_BoundBox.setFromObject(this.Wall7_Puerta2);
                scene.add(this.Wall7_Puerta2);




                
            }

            Colisiones()
            {
                this.Colision_Con_Jugador = false;

                if(this.Wall1_BoundBox.intersectsBox(this.Player_Temp_BB))
                {
            
                    this.Colision_Con_Jugador = true;
                }
                
                if(this.Wall2_BoundBox.intersectsBox(this.Player_Temp_BB)){
            
                    this.Colision_Con_Jugador = true;
                }

                if(this.Wall3_Puerta1_BoundBox.intersectsBox(this.Player_Temp_BB)){
            
                    this.Colision_Con_Jugador = true;
                }

                if(this.Wall4_BoundBox.intersectsBox(this.Player_Temp_BB)){
            
                    this.Colision_Con_Jugador = true;
                }

                if(this.Wall5_BoundBox.intersectsBox(this.Player_Temp_BB)){
            
                    this.Colision_Con_Jugador = true;
                }

                if(this.Wall6_BoundBox.intersectsBox(this.Player_Temp_BB)){
            
                    this.Colision_Con_Jugador = true;
                }

                if(this.Wall8_BoundBox.intersectsBox(this.Player_Temp_BB)){
            
                    this.Colision_Con_Jugador = true;
                }

                
                
                

            }
        }
        
        //#region COSAS DE LA ESCENA
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 8, 80);
        camera.lookAt(0, 0, 300);



        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.9);
        directionalLight.position.set(10, 15, 5);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        const controls = new OrbitControls(camera, renderer.domElement);

        


        const plane = new THREE.Mesh(
            new THREE.PlaneGeometry(40, 200),
            new THREE.MeshStandardMaterial({ color: "#8B4513" })
        );
        plane.rotation.x = -Math.PI / 2;
        plane.receiveShadow = true;
        scene.add(plane);

        const clock = new THREE.Clock();
        const loader = new GLTFLoader();
        //#endregion

        
        //#region JUGADOR
        let Jugador1_Mixer;
        

        

        let Jugador1;
        let Jugador1_Posicion_Anterior = new THREE.Vector3();
        let Jugador1_Colision = false;
        let JugadorPosX;
        let JugadorPosY;
        let JugadorPosZ;
        let Jugador1_BoundBox = new THREE.Box3();
        let box;
        loader.load('Personaje/personajeee.glb', (gltf) => {
            const model = gltf.scene;
            Jugador1 = gltf.scene;        


            Jugador1.traverse(child => { if (child.isMesh) child.castShadow = true; });
            Jugador1.scale.set(2, 2, 2);
            Jugador1.position.set(0, 0, 50);

            //Jugador1_Colision.setFromObject(Jugador1);

            scene.add(Jugador1);
            
            box = new THREE.BoxHelper( Jugador1, 0xffff00 );
            scene.add( box );


            if (gltf.animations.length) {
                Jugador1_Mixer = new THREE.AnimationMixer(Jugador1);
                Jugador1_Mixer.clipAction(gltf.animations[0]).play();
            }
        }, undefined, (error) => console.error(error));
        //#endregion
        
        
        //#region Habitacion 1 Resolver Puzzle
        const Puzzle_Resuelto_Geometry = new THREE.BoxGeometry(10, 5, 10);
        const Puzzle_Resuelto_Material = new THREE.MeshPhongMaterial({ color: "white" });
        const Puzzle_Resuelto = new THREE.Mesh(Puzzle_Resuelto_Geometry, Puzzle_Resuelto_Material);
        const Puzzle_Resuelto_BoundBox = new THREE.Box3();
        Puzzle_Resuelto.position.set(0, 0, 0);
        Puzzle_Resuelto_BoundBox.setFromObject(Puzzle_Resuelto);
        scene.add(Puzzle_Resuelto);
        //#endregion
        

        //#region FIN DEL NIVEL
        let FIN_DEL_NIVEL = false;
        let Jugador_Victoria = false;
        let Jugador_Derrota = false;

        const Zona_Victoria_Geometry = new THREE.BoxGeometry(10, 5, 10);
        const Zona_Victoria_Material = new THREE.MeshPhongMaterial({ color: "white" });
        const Zona_Victoria = new THREE.Mesh(Zona_Victoria_Geometry, Zona_Victoria_Material);
        const Zona_Victoria_BoundBox = new THREE.Box3();
        Zona_Victoria.position.set(0, 0, -50);
        Zona_Victoria_BoundBox.setFromObject(Zona_Victoria);
        scene.add(Zona_Victoria);

        //#endregion
        
        const Habitacion_1 = new Cuartos(0,0,0,Jugador1_BoundBox, "./uv_texture.jpg", "./temp_puerta.jpg");
        Habitacion_1.Construir_Cuarto();
        
        controls.target.set(0, 0, 0);

        controls.update();

        let Cambio_De_Mapa = false;
        
        
        


        function checkCollisions() {
            
            

            


            
            
            //Jugador Ganó Nivel
            if(Zona_Victoria_BoundBox.intersectsBox(Jugador1_BoundBox)){
            
                Zona_Victoria.material.color = new THREE.Color("black");
                FIN_DEL_NIVEL = true;
                Jugador_Victoria = true;
                
                
            }
            else{
            
                Zona_Victoria.material.color = new THREE.Color("white");
                
            }

            if(Puzzle_Resuelto_BoundBox.intersectsBox(Jugador1_BoundBox)){
            
                Habitacion_1.Cuarto_Terminado = true;
            }
            

            
        }


        function Nivel_Fue_Ganado(){
            
            //location.href = 'niveles.html';
            if(Cambio_De_Mapa == false){
                //location.href = 'niveles.html';
                location.href = 'GAMEOVER_win.html';
                
                console.log("Cambio de Nivel");
                Cambio_De_Mapa = true;
            }
        }

        function Nivel_Fue_Perdido(){
            
            //location.href = 'index.html';
            if(Cambio_De_Mapa == false){
                location.href = 'GAMEOVER_LOSE.html';
                console.log("Cambio de Nivel");
                Cambio_De_Mapa = true;
            }
        }

        const keyboard = {};
        document.addEventListener('keydown', (event) => { keyboard[event.code] = true; });
        document.addEventListener('keyup', (event) => { keyboard[event.code] = false; });

        

        function animate() {
            requestAnimationFrame(animate);

            const delta = clock.getDelta();
            
            if (FIN_DEL_NIVEL){
                
                Set_NivelActual();


                if (Jugador_Victoria == true){
                    Nivel_Fue_Ganado();
                    
                    

                                        
                }
                if (Jugador_Victoria == false){
                    Nivel_Fue_Perdido()
                    
                    
                }
                
                //location.href = 'niveles.html';
            }
            else{
                Jugador1_BoundBox.getCenter(Jugador1_Posicion_Anterior);
                Jugador1_BoundBox.setFromObject(Jugador1);

                const moveSpeed = 0.25;
                
                // Forward/Backward movement
                if (keyboard['KeyW']) {
                    Jugador1.position.z -= moveSpeed;
                }
                if (keyboard['KeyS']) {
                    Jugador1.position.z += moveSpeed;
                }

                // Strafe Left/Right
                if (keyboard['KeyA']) {
                    Jugador1.position.x -= moveSpeed;
                }
                if (keyboard['KeyD']) {
                    Jugador1.position.x += moveSpeed;
                }




                


                

                
                checkCollisions();
                Habitacion_1.Colisiones();

                if (Habitacion_1.Colision_Con_Jugador == true){
                    //Habitacion_1.Wall1.material.color = new THREE.Color("black");
                    
                    Jugador1.position.copy(Jugador1_Posicion_Anterior.position);
                }

                

                const center = new THREE.Vector3();
                Jugador1_BoundBox.getCenter(center);
                //Jugador1_Colision.update();
                box.update();

                if (Jugador1_Mixer) Jugador1_Mixer.update(delta);
            }



            

            

            

            if(Habitacion_1.Cuarto_Terminado == true){
                Habitacion_1.Wall3_Puerta1.position.y = -20;
                Habitacion_1.Wall7_Puerta2.position.y = -30;
            }
            else{
                Habitacion_1.Wall3_Puerta1.position.y = 10;
                Habitacion_1.Wall7_Puerta2.position.y = -30;
            }

            renderer.render(scene, camera);
        }

        animate();
    </script>
</body>

</html>